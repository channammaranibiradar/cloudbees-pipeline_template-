pipeline {
  agent {
    kubernetes {
      cloud 'rke2-agent'
      inheritFrom 'jenkins-kaniko-agent'
      defaultContainer 'jnlp'
    }
  }

  options {
    disableConcurrentBuilds(abortPrevious: true)
    timeout(time: 60, unit: 'MINUTES')
  }

  environment {
    IMAGE_NAME = "kamalakar2210/board_me"
    IMAGE_TAG  = "${BUILD_NUMBER}"

    // Trivy DB mirrors (already pushed by you)
    TRIVY_DB_REPOSITORY      = "docker.io/kamalakar2210/trivy-db"
    TRIVY_JAVA_DB_REPOSITORY = "docker.io/kamalakar2210/trivy-java-db"
  }

  stages {

    /* =================================================
       Verify Agent
       ================================================= */
    stage('Verify Agent') {
      steps {
        sh '''
          echo "=== VERIFY AGENT ==="
          whoami
          java -version
          mvn -version
          trivy --version
        '''
      }
    }

    /* =================================================
       Checkout Source
       ================================================= */
    stage('Checkout Source') {
      steps {
        checkout([
          $class: 'GitSCM',
          branches: [[name: '*/main']],
          userRemoteConfigs: [[
            url: 'https://github.com/kamalakar22/board_game.git',
            credentialsId: 'github-pat'
          ]]
        ])
      }
    }

    /* =================================================
       Maven Clean Install (BUILD ONCE)
       ================================================= */
    stage('Maven Clean Install') {
      steps {
        sh '''
          echo "=== MAVEN CLEAN INSTALL ==="
          mvn clean install -DskipTests
        '''
      }
    }

    /* =================================================
       SonarQube Scan (FAST – cache via PVC)
       ================================================= */
    stage('SonarQube Scan') {
      steps {
        withSonarQubeEnv('sonarqube') {
          sh '''
            echo "=== SONARQUBE SCAN ==="
            mvn org.sonarsource.scanner.maven:sonar-maven-plugin:5.5.0.6356:sonar \
              -Dsonar.projectKey=board-game \
              -Dsonar.projectName=board-game \
              -Dsonar.qualitygate.wait=false
          '''
        }
      }
    }

    /* =================================================
       Kaniko Build + Push + TAR (FAST)
       ================================================= */
    stage('Kaniko Build') {
      steps {
        container('kaniko') {
          sh '''
            echo "=== KANIKO BUILD ==="

            /kaniko/executor \
              --context /workspace \
              --dockerfile Dockerfile \
              --destination ${IMAGE_NAME}:${IMAGE_TAG} \
              --destination ${IMAGE_NAME}:latest \
              --tarPath image.tar \
              --verbosity=info
          '''
        }
      }
    }

    /* =================================================
       Prepare Trivy HTML Template
       ================================================= */
    stage('Prepare Trivy Template') {
      steps {
        sh '''
          mkdir -p trivy-templates trivy-reports

          if [ ! -f trivy-templates/html.tpl ]; then
            curl -fsSL \
              https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/html.tpl \
              -o trivy-templates/html.tpl
          fi
        '''
      }
    }

    /* =================================================
       Trivy Image Scan (NON-BLOCKING, ALL SEVERITIES)
       ================================================= */
    stage('Trivy Image Scan (NON-BLOCKING)') {
      steps {
        sh '''
          echo "=== TRIVY IMAGE SCAN (NON-BLOCKING) ==="

          trivy image \
            --scanners vuln \
            --input image.tar \
            --severity LOW,MEDIUM,HIGH,CRITICAL \
            --ignore-unfixed \
            --no-progress \
            --format template \
            --template @trivy-templates/html.tpl \
            --output trivy-reports/trivy-image-report.html || true
        '''
      }
    }
  }

  post {
    always {
      archiveArtifacts allowEmptyArchive: true, artifacts: 'trivy-reports/*.html'
      echo "Build #: ${BUILD_NUMBER}"
      echo "Result : ${currentBuild.currentResult}"
    }

    success {
      echo "✅ PIPELINE SUCCESS – Build, SonarQube & Trivy completed"
    }

    unstable {
      echo "⚠️ PIPELINE UNSTABLE – Review reports"
    }

    failure {
      echo "❌ PIPELINE FAILED"
    }
  }
}
