pipeline {
  agent { label "linux" }
  options {
    durabilityHint("PERFORMANCE_OPTIMIZED")
    timeout(time: 3, unit: "DAYS")
    disableConcurrentBuilds()
    skipDefaultCheckout true
  }
  environment {
    SNYK_TOKEN = credentials("snyk-token")
    MAVEN_HOME = tool "${mavenVersion}"
    JAVA_HOME = tool "${javaVersion}"
  }
  stages {
    stage("Checkout") {
      steps {
        checkout([$class: "GitSCM", 
          branches: [[name: "${branchName}"]], 
          doGenerateSubmoduleConfigurations: false, 
          extensions: [], 
          submoduleCfg: [], 
          userRemoteConfigs: [[credentialsId: "${gitCredentials}", url: "${repoUrl}"]]]
        )
      }
    }
    
    stage("Setup Environment") {
      steps {
        sh """
          echo "Maven Version: ${MAVEN_HOME}"
          echo "Java Version: ${JAVA_HOME}"
          export PATH="${MAVEN_HOME}/bin:${JAVA_HOME}/bin:\${PATH}"
        """
      }
    }
    
    stage("Build") {
      steps {
        sh "mvn ${buildGoals} -DskipTests"
      }
    }
    
    stage("Test") {
      steps {
        sh "mvn test"
      }
      post {
        always {
          junit 'target/surefire-reports/*.xml'
        }
      }
    }
    
    stage("Security Scan") {
      steps {
        sh """
          snyk auth \${SNYK_TOKEN}
          snyk test --all-projects
        """
      }
    }
    
    stage("Archive Artifacts") {
      steps {
        archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
      }
    }
  }
  
  post {
    always {
      cleanWs()
    }
    success {
      echo "Pipeline completed successfully!"
    }
    failure {
      echo "Pipeline failed!"
    }
  }
}
